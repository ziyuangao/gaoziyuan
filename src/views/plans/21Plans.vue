<template>
  <div class="header">
    <h1>å¥åº·æ•°æ®ç»Ÿè®¡æŠ¥å‘Š æ•°æ®å‘¨æœŸï¼š2025-07-09 è‡³ 2025-07-30ï¼ˆå…±22å¤©ï¼‰</h1>
  </div>
  <div class="charts-container">
    <!-- å›¾è¡¨1ï¼šè·‘æ­¥è·ç¦»æŠ˜çº¿å›¾ -->
    <div ref="distanceChart" class="chart"></div>

    <!-- å›¾è¡¨2ï¼šä¸å–ç³–æ°´æƒ…å†µé¥¼å›¾ -->
    <div ref="sugarChart" class="chart"></div>

    <!-- å›¾è¡¨3ï¼šç¡çœ æ—¶é—´å¯¹æ¯”æŸ±çŠ¶å›¾ -->
    <div ref="sleepChart" class="chart"></div>
  </div>
  <div>
    <div class="flex-container">
      <div class="flex-item">
        <div class="metric-card">
          <h2>ğŸƒ è¿åŠ¨ç›®æ ‡å®Œæˆç‡</h2>
          <div>æœ‰æ•ˆè¿åŠ¨å¤©æ•°ï¼š<span class="highlight">14å¤©</span>ï¼ˆå«è·‘æ­¥å’Œç¯®çƒï¼‰</div>
          <div>ä¼‘æ¯æ—¥ï¼š8å¤©ï¼ˆå…¶ä¸­3å¤©æœ‰æ˜ç¡®åŸå› ï¼‰</div>
          <div class="progress-bar">
            <div class="progress" style="width: 63.6%;">63.6%</div>
          </div>
          <table>
            <tr>
              <th>è¿åŠ¨ç±»å‹</th>
              <th>å¤©æ•°</th>
              <th>å æ¯”</th>
            </tr>
            <tr>
              <td>è·‘æ­¥</td>
              <td>11</td>
              <td>78.6%</td>
            </tr>
            <tr>
              <td>ç¯®çƒ</td>
              <td>3</td>
              <td>21.4%</td>
            </tr>
          </table>
        </div>

        <div class="metric-card">
          <h2>ğŸ¬ ä¸å–ç³–æ°´ç›®æ ‡è¾¾æˆ</h2>
          <div>å¿ä½äº†ï¼ˆYï¼‰ï¼š<span class="highlight success">20å¤©</span></div>
          <div>æ²¡å¿ä½ï¼ˆNï¼‰ï¼š2å¤©ï¼ˆ7æœˆ23æ—¥ã€7æœˆ20æ—¥ï¼‰</div>
          <div class="progress-bar">
            <div class="progress" style="width: 90.9%; background: #27ae60;">90.9%</div>
          </div>
        </div>
      </div>

      <div class="flex-item">
        <div class="metric-card">
          <h2>ğŸ˜´ ç¡çœ è®¡åˆ’éµå®ˆç‡ï¼ˆä¿®æ­£ç‰ˆï¼‰</h2>
          <div>å‡†æ—¶/æå‰å…¥ç¡ï¼š<span class="highlight">12å¤©</span></div>
          <div>ç†¬å¤œå¤©æ•°ï¼š10å¤©ï¼ˆå«<span class="highlight warning">4æ¬¡æç«¯ç†¬å¤œ</span>ï¼‰</div>
          <div class="progress-bar">
            <div class="progress" style="width: 54.5%; background: #f39c12;">54.5%</div>
          </div>
          <table>
            <tr>
              <th>åå·®ç±»å‹</th>
              <th>å¹³å‡æ—¶é—´</th>
              <th>æœ€å¤§åå·®</th>
            </tr>
            <tr>
              <td>æå‰å…¥ç¡</td>
              <td>23åˆ†é’Ÿ</td>
              <td>1å°æ—¶19åˆ†é’Ÿ</td>
            </tr>
            <tr>
              <td>å»¶è¿Ÿå…¥ç¡</td>
              <td>1å°æ—¶14åˆ†é’Ÿ</td>
              <td>7å°æ—¶20åˆ†é’Ÿï¼ˆ7æœˆ25æ—¥ï¼‰</td>
            </tr>
          </table>
        </div>
      </div>
    </div>

    <div class="final-score">
      ç»¼åˆå¥åº·ç›®æ ‡å®Œæˆåº¦ï¼š<span style="font-size: 36px; font-weight: bold;">70.4%</span>
      <div style="font-size: 16px;">ï¼ˆè¿åŠ¨40% + ä¸å–ç³–æ°´30% + ç¡çœ 30%ï¼‰</div>
    </div>

    <div class="metric-card">
      <h2>ğŸ“Š è¯¦ç»†æ•°æ®æƒé‡åˆ†æ</h2>
      <table>
        <tr>
          <th>è¯„ä¼°ç»´åº¦</th>
          <th>åŸå§‹å®Œæˆç‡</th>
          <th>æƒé‡</th>
          <th>åŠ æƒå¾—åˆ†</th>
        </tr>
        <tr>
          <td>è¿åŠ¨ç›®æ ‡</td>
          <td>63.6%</td>
          <td>40%</td>
          <td>25.4%</td>
        </tr>
        <tr>
          <td>ä¸å–ç³–æ°´ç›®æ ‡</td>
          <td>90.9%</td>
          <td>30%</td>
          <td>27.3%</td>
        </tr>
        <tr>
          <td>ç¡çœ ç›®æ ‡</td>
          <td>59.1%</td>
          <td>30%</td>
          <td>17.7%</td>
        </tr>
        <tr style="font-weight: bold; background-color: #f2f2f2;">
          <td colspan="3">æ€»åˆ†</td>
          <td>70.4%</td>
        </tr>
      </table>
    </div>

    <div style="text-align: center; margin-top: 30px; color: #7f8c8d; font-size: 14px;">
      æ•°æ®ç»Ÿè®¡æ—¶é—´ï¼š2025å¹´7æœˆ â€¢ åŸºäº22å¤©è·Ÿè¸ªæ•°æ®
    </div>
  </div>
</template>

<script>
import { ref, onMounted } from 'vue';
import * as echarts from 'echarts';
import no1Data from "@/dataPool/plans/no1.json"
export default {
  setup() {
    const planDataArr = no1Data
    const distanceChart = ref(null);
    const sugarChart = ref(null);
    const sleepChart = ref(null);

    onMounted(() => {
      initDistanceChart();
      initSugarChart();
      initSleepChart();
    });

    // å¤„ç†æ—¶é—´æ ¼å¼ï¼ˆå°†"23:30"è½¬æ¢ä¸ºåˆ†é’Ÿæ•°ï¼‰
    const timeToMinutes = (timeStr) => {
      if (!timeStr) return 0;
      const [hours, minutes] = timeStr.split(':').map(Number);
      return hours * 60 + minutes;
    };

    // å›¾è¡¨1ï¼šè·‘æ­¥è·ç¦»æŠ˜çº¿å›¾
    const initDistanceChart = () => {
      const chart = echarts.init(distanceChart.value);

      const dates = planDataArr.map(item => item.date.substring(5)); // åªæ˜¾ç¤ºæœˆ-æ—¥
      const distances = planDataArr.map(item => parseFloat(item.distance) || 0);

      const option = {
        title: { text: 'æ¯æ—¥è·‘æ­¥è·ç¦»(å…¬é‡Œ)', left: 'center' },
        tooltip: {
          trigger: 'item',
          formatter: (params) => {
            const item = planDataArr[params.dataIndex];
            if (item.notes) {
              return `${item.date}<br/>å¤‡æ³¨: ${item.notes}`;
            }
            if (item.distance == 0) {
              return `${item.date}<br/>å¤‡æ³¨: å·æ‡’äº†æ²¡å»è·‘`;
            } else {
              return `${item.date}<br/>è·ç¦»: ${item.distance}å…¬é‡Œ<br/>å¡è·¯é‡Œ: ${item.calorie}kcal`;
            }
          }
        },
        xAxis: {
          type: 'category',
          data: dates,
          axisLabel: { rotate: 45 }
        },
        yAxis: { type: 'value', name: 'è·ç¦»(å…¬é‡Œ)' },
        series: [{
          data: distances,
          type: 'line',
          smooth: true,
          symbol: 'circle',
          symbolSize: 8,
          itemStyle: { color: '#5470C6' },
          lineStyle: { width: 3 }
        }],
        grid: { containLabel: true }
      };

      chart.setOption(option);
      window.addEventListener('resize', () => chart.resize());
    };

    // å›¾è¡¨2ï¼šä¸å–ç³–æ°´æƒ…å†µé¥¼å›¾
    const initSugarChart = () => {
      const chart = echarts.init(sugarChart.value);

      const sugarData = planDataArr.reduce((acc, item) => {
        acc[item.sugarFree] = (acc[item.sugarFree] || 0) + 1;
        return acc;
      }, { Y: 0, N: 0 });

      const option = {
        title: { text: 'ä¸å–ç³–æ°´æƒ…å†µç»Ÿè®¡', left: 'center' },
        tooltip: { trigger: 'item' },
        series: [{
          name: 'ä¸å–ç³–é¥®æ–™æƒ…å†µ',
          type: 'pie',
          radius: '70%',
          data: [
            { value: sugarData.Y, name: 'å¿ä½äº†(Y)', itemStyle: { color: '#91CC75' } },
            { value: sugarData.N, name: 'æ²¡å¿ä½(N)', itemStyle: { color: '#EE6666' } }
          ],
          label: {
            formatter: '{b}: {d}% ({c}å¤©)'
          },
          emphasis: {
            itemStyle: { shadowBlur: 10, shadowOffsetX: 0 }
          }
        }]
      };

      chart.setOption(option);
      window.addEventListener('resize', () => chart.resize());
    };

    // å›¾è¡¨3ï¼šç¡çœ æ—¶é—´å¯¹æ¯”æŸ±çŠ¶å›¾
    const initSleepChart = () => {
      const chart = echarts.init(sleepChart.value);

      // æ•°æ®å¤„ç†å‡½æ•°ï¼šå°†æ—¶é—´å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ ‡å‡†åŒ–åˆ†é’Ÿæ•°ï¼ˆæ”¯æŒè¶…è¿‡24å°æ—¶ï¼‰
      const parseTimeToMinutes = (timeStr) => {
        let [h, m] = timeStr.split(':').map(Number);
        // ä¿ç•™åŸå§‹è¶…è¿‡24å°æ—¶çš„æ•°æ®ï¼ˆå¦‚30:50 â†’ 30*60+50=1850ï¼‰
        return h * 60 + m;
      };

      // åˆ†é’Ÿæ•°è½¬æ˜¾ç¤ºæ—¶é—´ï¼ˆå¤„ç†è¶…è¿‡24å°æ—¶çš„æƒ…å†µï¼‰
      const formatMinutesToTime = (totalMinutes) => {
        const isNextDay = totalMinutes >= 1440; // 1440åˆ†é’Ÿ=24å°æ—¶
        const displayMins = isNextDay ? totalMinutes - 1440 : totalMinutes;
        const h = Math.floor(displayMins / 60);
        const m = displayMins % 60;
        return `${h}:${m.toString().padStart(2, '0')}${isNextDay ? ' (æ¬¡æ—¥)' : ''}`;
      };

      // å‡†å¤‡æ•°æ®
      const dates = planDataArr.map(item => item.date.substring(5));
      const expectedTimes = planDataArr.map(item => parseTimeToMinutes(item.expectedBedtime));
      const actualTimes = planDataArr.map(item => parseTimeToMinutes(item.actualBedtime));

      // è®¡ç®—Yè½´èŒƒå›´ï¼ˆåŠ¨æ€é€‚åº”æ•°æ®ï¼‰
      const allTimes = [...expectedTimes, ...actualTimes].filter(t => t > 0);
      const minTime = Math.min(...allTimes);
      const maxTime = Math.max(...allTimes);

      // ç¡®ä¿åŸºå‡†ä»22:00(1320)å¼€å§‹ï¼Œæœ€å¤§åˆ°æ¬¡æ—¥6:00(1800)
      const yAxisMin = Math.min(22 * 60, Math.floor(minTime / 60) * 60);
      const yAxisMax = Math.max(26 * 60, Math.ceil(maxTime / 60) * 60);

      const option = {
        title: { text: 'è®¡åˆ’ vs å®é™…ç¡çœ æ—¶é—´', left: 'center' },
        tooltip: {
          trigger: 'axis',
          formatter: (params) => {
            const data = planDataArr[params[0].dataIndex];
            return `
          ${data.date}<br/>
          è®¡åˆ’: ${formatMinutesToTime(parseTimeToMinutes(data.expectedBedtime))}<br/>
          å®é™…: ${formatMinutesToTime(parseTimeToMinutes(data.actualBedtime))}
        `;
          }
        },
        xAxis: {
          type: 'category',
          data: dates,
          axisLabel: { rotate: 45 }
        },
        yAxis: {
          type: 'value',
          name: 'å°±å¯æ—¶é—´',
          min: yAxisMin,
          max: yAxisMax,
          axisLabel: {
            formatter: (totalMinutes) => formatMinutesToTime(totalMinutes)
          },
          axisPointer: {
            label: {
              formatter: ({ value }) => formatMinutesToTime(value)
            }
          }
        },
        series: [
          {
            name: 'è®¡åˆ’æ—¶é—´',
            data: expectedTimes,
            type: 'bar',
            barGap: 0,
            itemStyle: { color: '#5470C6' }
          },
          {
            name: 'å®é™…æ—¶é—´',
            data: actualTimes,
            type: 'bar',
            itemStyle: {
              color: ({ dataIndex }) => {
                const actual = actualTimes[dataIndex];
                const expected = expectedTimes[dataIndex];
                // å®é™…æ¯”è®¡åˆ’æ™š30åˆ†é’Ÿä»¥ä¸Šæ˜¾ç¤ºçº¢è‰²
                return actual - expected > 30 ? '#EE6666' : '#91CC75';
              }
            }
          }
        ]
      };
      chart.setOption(option);
      window.addEventListener('resize', () => chart.resize());
    };

    return { distanceChart, sugarChart, sleepChart };
  }
};
</script>

<style scoped>
.charts-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
}

.header {
  padding: 20px 0;
}

.chart {
  width: 100%;
  height: 400px;
  border: 1px solid #eee;
  border-radius: 8px;
  padding: 10px;
  box-sizing: border-box;
}

/* è®©ç¬¬ä¸€ä¸ªå›¾è¡¨å æ®æ•´è¡Œ */
.chart:first-child {
  grid-column: 1 / -1;
}

.chart:last-child {
  grid-column: 1 / -1;
}

@media (max-width: 768px) {
  .charts-container {
    grid-template-columns: 1fr;
  }
}

h1 {
  color: #2c3e50;
  text-align: center;
  border-bottom: 2px solid #3498db;
  padding-bottom: 10px;
}

h2 {
  color: #2980b9;
  margin-top: 25px;
  border-left: 4px solid #3498db;
  padding-left: 10px;
}

.metric-card {
  background: white;
  border-radius: 8px;
  padding: 15px;
  margin: 15px 0;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.progress-bar {
  height: 20px;
  background: #ecf0f1;
  border-radius: 10px;
  margin: 10px 0;
  overflow: hidden;
}

.progress {
  height: 100%;
  border-radius: 10px;
  background: #3498db;
  text-align: center;
  color: white;
  font-size: 12px;
  line-height: 20px;
}

.highlight {
  font-weight: bold;
  color: #e74c3c;
}

.success {
  color: #27ae60;
}

.warning {
  color: #f39c12;
}

.flex-container {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
}

.flex-item {
  width: 48%;
  min-width: 300px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin: 15px 0;
}

th,
td {
  padding: 10px;
  text-align: left;
  border-bottom: 1px solid #ddd;
}

th {
  background-color: #f2f2f2;
}

.final-score {
  text-align: center;
  font-size: 24px;
  margin: 30px 0;
  padding: 20px;
  background: linear-gradient(135deg, #3498db, #2ecc71);
  color: white;
  border-radius: 8px;
}
</style>